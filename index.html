<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subreddit Stats</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="stats-container">
      <div class="stat-card">
        <h3>Growth Today</h3>
        <p id="growth-today" class="stat-value">+0</p>
        <p class="stat-sub">last 24h</p>
      </div>
      <div class="stat-card">
        <h3>Growth This Week</h3>
        <p id="growth-week" class="stat-value">+0</p>
        <p class="stat-sub">last 7d</p>
      </div>
      <div class="stat-card">
        <h3>Growth This Month</h3>
        <p id="growth-month" class="stat-value">+0</p>
        <p class="stat-sub">last 30d</p>
      </div>
      <div class="stat-card">
        <h3>Growth This Year</h3>
        <p id="growth-year" class="stat-value">+0</p>
        <p class="stat-sub">last 12m</p>
      </div>
    </div>

    <p class="last-updated">Last updated: <span id="last-updated"></span></p>

    <div class="graph-container">
      <div class="range-selector">
        <button onclick="updateChart('24h')">24 Hours</button>
        <button onclick="updateChart('7d')">7 Days</button>
        <button onclick="updateChart('30d')">30 Days</button>
        <button class="active" onclick="updateChart('12m')">12 Months</button>
      </div>
      <canvas id="growthChart"></canvas>
    </div>

    <script>
      let chart;
      let allData = [];

      async function fetchData() {
        const res = await fetch("data.json");
        const json = await res.json();
        allData = json.logs
          .map((entry) => ({
            time: new Date(entry.time),
            count: entry.count,
          }))
          .sort((a, b) => a.time - b.time);

        updateAllStats();
        updateChart("12m");
      }

      function updateAllStats() {
        const now = allData[allData.length - 1];
        const nowTime = now.time.getTime();

        const oneDayAgo = nowTime - 24 * 60 * 60 * 1000;
        const oneWeekAgo = nowTime - 7 * 24 * 60 * 60 * 1000;
        const oneMonthAgo = nowTime - 30 * 24 * 60 * 60 * 1000;
        const oneYearAgo = nowTime - 365 * 24 * 60 * 60 * 1000;

        const todayStart = getNearestCount(oneDayAgo);
        const weekStart = getNearestCount(oneWeekAgo);
        const monthStart = getNearestCount(oneMonthAgo);
        const yearStart = getNearestCount(oneYearAgo);

        const todayGrowth = now.count - todayStart;
        const weekGrowth = now.count - weekStart;
        const monthGrowth = now.count - monthStart;
        const yearGrowth = now.count - yearStart;

        document.getElementById("growth-today").textContent = `+${todayGrowth.toLocaleString()}`;
        document.getElementById("growth-week").textContent = `+${weekGrowth.toLocaleString()}`;
        document.getElementById("growth-month").textContent = `+${monthGrowth.toLocaleString()}`;
        document.getElementById("growth-year").textContent = `+${yearGrowth.toLocaleString()}`;

        document.getElementById("last-updated").textContent =
          new Date(now.time).toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
      }

      function getNearestCount(targetTime) {
        let nearest = allData[0].count;
        for (let i = 0; i < allData.length; i++) {
          if (allData[i].time.getTime() > targetTime) {
            return allData[i > 0 ? i - 1 : 0].count;
          }
        }
        return allData[allData.length - 1].count;
      }

      function updateChart(range) {
        let cutoffTime;
        const now = allData[allData.length - 1].time.getTime();

        switch (range) {
          case "24h":
            cutoffTime = now - 24 * 60 * 60 * 1000;
            break;
          case "7d":
            cutoffTime = now - 7 * 24 * 60 * 60 * 1000;
            break;
          case "30d":
            cutoffTime = now - 30 * 24 * 60 * 60 * 1000;
            break;
          case "12m":
          default:
            cutoffTime = now - 365 * 24 * 60 * 60 * 1000;
            break;
        }

        const filtered = allData.filter((d) => d.time.getTime() >= cutoffTime);

        const labels =
          range === "12m"
            ? filtered.map((d) =>
                d.time.toLocaleDateString("en-IN", { month: "short", year: "2-digit" })
              )
            : filtered.map((d) =>
                d.time.toLocaleString("en-IN", {
                  day: "2-digit",
                  month: "short",
                  hour: "2-digit",
                  minute: "2-digit",
                })
              );

        const counts = filtered.map((d) => d.count);

        if (chart) chart.destroy();

        const ctx = document.getElementById("growthChart").getContext("2d");
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Subscriber Count",
                data: counts,
                borderColor: "rgba(0, 255, 0, 0.8)",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.25,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text:
                    range === "12m"
                      ? "Date (Last 12 Months)"
                      : "Time",
                  color: "#ccc",
                },
                ticks: { color: "#aaa", maxRotation: 0 },
              },
              y: {
                title: {
                  display: true,
                  text: "Subscribers",
                  color: "#ccc",
                },
                ticks: { color: "#aaa" },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.parsed.y.toLocaleString()} subscribers`;
                  },
                },
              },
            },
          },
        });

        document
          .querySelectorAll(".range-selector button")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelector(`.range-selector button[onclick="updateChart('${range}')"]`)
          .classList.add("active");
      }

      fetchData();
    </script>
  </body>
</html>
