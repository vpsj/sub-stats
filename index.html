<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>r/IndianRailways — Subscribers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1113;
      --panel:#111214;
      --muted:#bbb;
      --accent:#4CAF50;
      --card-radius:12px;
      --pad:16px;
    }
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:linear-gradient(180deg, #0b0b0d 0%, #121214 100%);
      color:#fff;
      padding:20px;
      -webkit-font-smoothing:antialiased;
    }
    .container{
      max-width:980px;
      margin:0 auto;
    }
    header { text-align:center; margin-bottom:8px; }
    h1 { margin:6px 0; font-size:1.6rem; font-weight:600; }
    #count { font-size:3.8rem; font-weight:800; color:var(--accent); letter-spacing:0.02em; }
    .card {
      background: rgba(255,255,255,0.02);
      border-radius:var(--card-radius);
      padding:var(--pad);
      margin:12px 0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }
    .stats { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    .stat {
      min-width:180px;
      background:rgba(255,255,255,0.02);
      padding:12px;
      border-radius:10px;
      text-align:center;
    }
    .stat b { display:block; font-size:0.95rem; margin-bottom:6px; color:#fff; }
    .stat .val { font-size:1.25rem; font-weight:700; color:var(--accent); }
    .stat .prev { color:var(--muted); font-size:0.85rem; margin-top:6px; display:block; }
    #lastUpdated { color:var(--muted); text-align:center; margin-top:8px; font-size:0.9rem; }

    /* tabs */
    .tabs { display:flex; gap:8px; justify-content:center; margin-top:18px; flex-wrap:wrap; }
    .tab-btn { background:#222; color:#ddd; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; }
    .tab-btn.active { background:var(--accent); color:#021805; font-weight:700; }

    canvas { max-width:100%; margin-top:12px; display:block; }

    /* responsive */
    @media (max-width:640px){
      #count { font-size:2.4rem; }
      .stat { min-width:140px; }
      h1 { font-size:1.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>r/IndianRailways Subscribers</h1>
      <div id="count">—</div>
    </header>

    <div class="card">
      <div class="stats">
        <div class="stat">
          <b>Growth Today</b>
          <div class="val" id="dailyGrowth">0</div>
          <div class="prev" id="dailyPrev">from —</div>
        </div>
        <div class="stat">
          <b>Growth This Week</b>
          <div class="val" id="weeklyGrowth">0</div>
          <div class="prev" id="weeklyPrev">from —</div>
        </div>
        <div class="stat">
          <b>Growth This Month</b>
          <div class="val" id="monthlyGrowth">0</div>
          <div class="prev" id="monthlyPrev">from —</div>
        </div>
        <div class="stat">
          <b>Growth This Year</b>
          <div class="val" id="yearlyGrowth">0</div>
          <div class="prev" id="yearlyPrev">from —</div>
        </div>
      </div>
      <div id="lastUpdated">Last updated: — (IST)</div>
    </div>

    <div class="card">
      <div style="text-align:center"><small class="muted">Graph range</small></div>
      <div class="tabs" role="tablist" aria-label="Ranges">
        <button class="tab-btn active" data-range="24h">24 Hours</button>
        <button class="tab-btn" data-range="7d">7 Days</button>
        <button class="tab-btn" data-range="30d">30 Days</button>
        <button class="tab-btn" data-range="12m">12 Months</button>
      </div>
      <canvas id="growthChart" height="160"></canvas>
    </div>

    <div style="text-align:center; color:var(--muted); margin-top:10px;">
      Data stored in <code>data.json</code> (updated hourly by GitHub Actions).
    </div>
  </div>

  <script>
    const DATA_URL = 'data.json'; // relative path to your GitHub Pages data.json
    const IST_OFFSET = 5.5 * 60 * 60 * 1000; // ms

    let logs = [];
    let chart = null;
    let currentRange = '24h';

    function asNumber(n){ return +n; }
    function toIST(ms){ return new Date(ms + IST_OFFSET); }

    function startOfDayIST(ms){
      const d = new Date(ms + IST_OFFSET);
      return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) - IST_OFFSET;
    }
    function startOfWeekIST(ms){
      const d = new Date(ms + IST_OFFSET);
      const day = d.getUTCDay();
      const offset = (day + 6) % 7;
      return startOfDayIST(ms) - offset*24*3600*1000;
    }
    function startOfMonthIST(ms){
      const d = new Date(ms + IST_OFFSET);
      return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(),1)-IST_OFFSET;
    }
    function startOfYearIST(ms){
      const d = new Date(ms + IST_OFFSET);
      return Date.UTC(d.getUTCFullYear(),0,1)-IST_OFFSET;
    }
    function formatIST(ms, opts){
      return new Intl.DateTimeFormat('en-IN', Object.assign({ timeZone:'Asia/Kolkata'}, opts)).format(new Date(ms));
    }

    async function fetchSharedData(){
      try{
        const res = await fetch(DATA_URL+'?t='+Date.now(), { cache:'no-store' });
        if(!res.ok) throw new Error(res.status);
        const json = await res.json();
        logs = (json.logs || []).map(l => ({ time: asNumber(l.time), count: asNumber(l.count) }));
        logs.sort((a,b)=>a.time-b.time);
        localStorage.setItem('sharedLogs', JSON.stringify(logs));
      }catch(e){
        const cached = localStorage.getItem('sharedLogs');
        if(cached) logs = JSON.parse(cached);
      }
    }

    function getLatest(){ return logs.length ? logs[logs.length-1] : null; }
    function baseline(startMs){
      for(let i=logs.length-1;i>=0;i--){
        if(logs[i].time<=startMs) return logs[i].count;
      }
      return logs.length ? logs[0].count : 0;
    }

    function computeStats(){
      const latest = getLatest();
      if(!latest) return;
      document.getElementById('count').innerText = latest.count.toLocaleString();

      const now = Date.now();
      const bDay=startOfDayIST(now), bWeek=startOfWeekIST(now), bMonth=startOfMonthIST(now), bYear=startOfYearIST(now);
      const baseDay=baseline(bDay), baseWeek=baseline(bWeek), baseMonth=baseline(bMonth), baseYear=baseline(bYear);

      const dg=latest.count-baseDay, wg=latest.count-baseWeek, mg=latest.count-baseMonth, yg=latest.count-baseYear;
      document.getElementById('dailyGrowth').innerText = (dg>=0?'+':'')+dg.toLocaleString();
      document.getElementById('weeklyGrowth').innerText = (wg>=0?'+':'')+wg.toLocaleString();
      document.getElementById('monthlyGrowth').innerText = (mg>=0?'+':'')+mg.toLocaleString
