<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>r/IndianRailways Subscribers</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; text-align:center; padding:20px; }
    h1 { font-size: 2rem; }
    .count { font-size: 4rem; font-weight:bold; margin:20px 0; }
    .growth { margin: 10px 0; }
    button { padding:10px 20px; font-size:1rem; cursor:pointer; margin-top:10px; }
    .timestamp { margin-top: 10px; font-size:0.9rem; color:#aaa; }
  </style>
</head>
<body>
  <h1>r/IndianRailways Subscribers</h1>
  <div class="count" id="subCount">—</div>
  <div class="growth">
    Growth Today: <span id="growthDay">0</span> from <span id="prevDay">—</span><br>
    Growth This Week: <span id="growthWeek">0</span> from <span id="prevWeek">—</span><br>
    Growth This Month: <span id="growthMonth">0</span> from <span id="prevMonth">—</span><br>
    Growth This Year: <span id="growthYear">0</span> from <span id="prevYear">—</span>
  </div>
  <div class="timestamp" id="lastUpdated">Last updated: — (IST)</div>
  <button onclick="updateSubs()">Update Now</button>

  <script>
    const DATA_URL = 'https://raw.githubusercontent.com/vpsj/sub-stats/main/data.json';
    const SUBREDDIT = 'indianrailways';

    async function fetchLiveCount() {
      try {
        const res = await fetch(`https://www.reddit.com/r/${SUBREDDIT}/about.json?raw_json=1`, {cache:'no-store'});
        const json = await res.json();
        return json.data.subscribers || 0;
      } catch(e) {
        console.warn('Live Reddit fetch failed', e);
        return null;
      }
    }

    async function updateSubs() {
      let logs = [];
      let liveCount = null;

      // Try fetching data.json first
      try {
        const res = await fetch(DATA_URL+'?t='+Date.now(), {cache:'no-store'});
        logs = (await res.json()).logs || [];
      } catch(e) {
        console.warn('Failed to fetch GitHub data.json, falling back to live Reddit', e);
        liveCount = await fetchLiveCount();
      }

      // Determine latest subscriber count
      let latestCount = liveCount || (logs.length ? logs[logs.length-1].count : '—');
      document.getElementById('subCount').textContent = latestCount;

      // Calculate growth if logs exist
      if (logs.length) {
        const now = Date.now();
        const dayMs = 24*60*60*1000;
        const weekMs = 7*dayMs;
        const monthMs = 30*dayMs;
        const yearMs = 365*dayMs;

        function prevCount(delta) {
          for (let i = logs.length-1; i>=0; i--) {
            if ((now - logs[i].time) >= delta) return logs[i].count;
          }
          return logs[0].count;
        }

        const pd = prevCount(dayMs);
        const pw = prevCount(weekMs);
        const pm = prevCount(monthMs);
        const py = prevCount(yearMs);

        document.getElementById('growthDay').textContent = latestCount - pd;
        document.getElementById('prevDay').textContent = pd;
        document.getElementById('growthWeek').textContent = latestCount - pw;
        document.getElementById('prevWeek').textContent = pw;
        document.getElementById('growthMonth').textContent = latestCount - pm;
        document.getElementById('prevMonth').textContent = pm;
        document.getElementById('growthYear').textContent = latestCount - py;
        document.getElementById('prevYear').textContent = py;
      }

      // Show last updated IST time
      const d = new Date();
      const utcTime = d.getTime() + d.getTimezoneOffset()*60*1000; // UTC in ms
      const istTime = new Date(utcTime + 5.5*60*60*1000); // add 5.5 hours for IST
      document.getElementById('lastUpdated').textContent = 'Last updated: ' + istTime.toLocaleString('en-IN') + ' (IST)';
    }

    // Auto-update every hour
    updateSubs();
    setInterval(updateSubs, 60*60*1000);
  </script>
</body>
</html>
